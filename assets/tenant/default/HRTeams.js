(()=>{"use strict";var e,t,i,a={},n={};function s(e){var t=n[e];if(void 0!==t)return t.exports;var i=n[e]={id:e,exports:{}};return a[e](i,i.exports,s),i.exports}s.m=a,e=[],s.O=(t,i,a,n)=>{if(!i){var o=1/0;for(c=0;c<e.length;c++){for(var[i,a,n]=e[c],l=!0,r=0;r<i.length;r++)(!1&n||o>=n)&&Object.keys(s.O).every((e=>s.O[e](i[r])))?i.splice(r--,1):(l=!1,n<o&&(o=n));if(l){e.splice(c--,1);var d=a();void 0!==d&&(t=d)}}return t}n=n||0;for(var c=e.length;c>0&&e[c-1][2]>n;c--)e[c]=e[c-1];e[c]=[i,a,n]},s.F={},s.E=e=>{Object.keys(s.F).map((t=>{s.F[t](e)}))},s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.f={},s.e=e=>Promise.all(Object.keys(s.f).reduce(((t,i)=>(s.f[i](e,t),t)),[])),s.u=e=>"HR"+e+".js",s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),t={},i="hrteamwidget:",s.l=(e,a,n,o)=>{if(t[e])t[e].push(a);else{var l,r;if(void 0!==n)for(var d=document.getElementsByTagName("script"),c=0;c<d.length;c++){var h=d[c];if(h.getAttribute("src")==e||h.getAttribute("data-webpack")==i+n){l=h;break}}l||(r=!0,(l=document.createElement("script")).charset="utf-8",l.timeout=120,s.nc&&l.setAttribute("nonce",s.nc),l.setAttribute("data-webpack",i+n),l.src=e),t[e]=[a];var u=(i,a)=>{l.onerror=l.onload=null,clearTimeout(p);var n=t[e];if(delete t[e],l.parentNode&&l.parentNode.removeChild(l),n&&n.forEach((e=>e(a))),i)return i(a)},p=setTimeout(u.bind(null,void 0,{type:"timeout",target:l}),12e4);l.onerror=u.bind(null,l.onerror),l.onload=u.bind(null,l.onload),r&&document.head.appendChild(l)}},s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;s.g.importScripts&&(e=s.g.location+"");var t=s.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var i=t.getElementsByTagName("script");if(i.length)for(var a=i.length-1;a>-1&&(!e||!/^http(s?):/.test(e));)e=i[a--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),s.p=e})(),(()=>{var e={743:0};s.f.j=(t,i)=>{var a=s.o(e,t)?e[t]:void 0;if(0!==a)if(a)i.push(a[2]);else{var n=new Promise(((i,n)=>a=e[t]=[i,n]));i.push(a[2]=n);var o=s.p+s.u(t),l=new Error;s.l(o,(i=>{if(s.o(e,t)&&(0!==(a=e[t])&&(e[t]=void 0),a)){var n=i&&("load"===i.type?"missing":i.type),o=i&&i.target&&i.target.src;l.message="Loading chunk "+t+" failed.\n("+n+": "+o+")",l.name="ChunkLoadError",l.type=n,l.request=o,a[1](l)}}),"chunk-"+t,t)}},s.F.j=t=>{if(!s.o(e,t)||void 0===e[t]){e[t]=null;var i=document.createElement("link");s.nc&&i.setAttribute("nonce",s.nc),i.rel="prefetch",i.as="script",i.href=s.p+s.u(t),document.head.appendChild(i)}},s.O.j=t=>0===e[t];var t=(t,i)=>{var a,n,[o,l,r]=i,d=0;if(o.some((t=>0!==e[t]))){for(a in l)s.o(l,a)&&(s.m[a]=l[a]);if(r)var c=r(s)}for(t&&t(i);d<o.length;d++)n=o[d],s.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return s.O(c)},i=self.webpackChunkhrteamwidget=self.webpackChunkhrteamwidget||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})(),s.nc=void 0,s.O(0,[743],(()=>{[556,702,709].map(s.E)}),5);var o={};const l={datacollectionID:"",teamLink:"",teamName:"",topTeam:"",teamStrategy:"",subStrategy:"",strategyCode:"",strategyColors:[],fields:"",direction:"t2b",depth:99,color:"#00BCD4",draggable:1,showGroupTitle:0,dropContentToCreate:0,pan:1,zoom:1,height:0,export:0,exportFilename:"",contentField:"",editContentFieldsToCreateNew:[],setEditableContentFields:[],contentFieldFilter:null,contentFieldDateStart:"",contentFieldDateEnd:"",contentGroupByField:"",contentDisplayedFields:{},contentDisplayedFieldTypes:{},contentDisplayedFieldMappingData:{},contentDisplayedFieldFilters:{},showDataPanel:0,dataPanelDCs:{}},r={key:"plugin_hr_teams",icon:"users",labelKey:"HR Teams"};function d(e,t){const i=document.createElement(e);return i.classList.add(...t.split(" ")),i}function c(e){return{id:e.id,value:e.text}}function h(e,t){return(e.lastName??"").toLowerCase()>(t.lastName??"").toLowerCase()?1:-1}function u(e,t){const i=(a=e,class extends a{constructor(e,t,i,a){super(e,t,i,a||r)}static common(){return r}static defaultValues(){return l}fromValues(e){super.fromValues(e),this.settings.datacollectionID=this.settings.datacollectionID??l.datacollectionID,this.settings.teamLink=this.settings.teamLink??l.teamLink,this.settings.teamName=this.settings.teamName??l.teamName,this.settings.topTeam=this.settings.topTeam??l.topTeam,this.settings.teamInactive=this.settings.teamInactive??l.teamInactive,this.settings.teamCanInactivate=this.settings.teamCanInactivate??l.teamCanInactivate,this.settings.teamStrategy=this.settings.teamStrategy??l.teamStrategy,this.settings.subStrategy=this.settings.subStrategy??l.subStrategy,this.settings.strategyCode=this.settings.strategyCode??l.strategyCode,this.settings.strategyColors=this.settings.strategyColors??l.strategyColors,this.settings.direction=this.settings.direction??l.direction,this.settings.depth=parseInt(this.settings.depth??l.depth),this.settings.color=this.settings.color??l.color,this.settings.pan=JSON.parse(this.settings.pan??l.pan),this.settings.zoom=JSON.parse(this.settings.zoom??l.zoom),this.settings.draggable=JSON.parse(this.settings.draggable??l.draggable),this.settings.dropContentToCreate=JSON.parse(this.settings.dropContentToCreate??l.dropContentToCreate),this.settings.height=parseInt(this.settings.height??l.height),this.settings.export=JSON.parse(this.settings.export??l.export),this.settings.exportFilename=this.settings.exportFilename??l.exportFilename,this.settings.contentField=this.settings.contentField??l.contentField,this.settings.editContentFieldsToCreateNew=this.settings.editContentFieldsToCreateNew??l.editContentFieldsToCreateNew,this.settings.setEditableContentFields=this.settings.setEditableContentFields??l.setEditableContentFields,this.settings.contentFieldFilter=this.settings.contentFieldFilter??l.contentFieldFilter,this.settings.contentFieldDateStart=this.settings.contentFieldDateStart??l.contentFieldDateStart,this.settings.connectFieldDateEnd=this.settings.connectFieldDateEnd??l.contentFieldDateEnd,this.settings.contentGroupByField=this.settings.contentGroupByField??l.contentGroupByField,this.settings.showGroupTitle=this.settings.showGroupTitle??l.showGroupTitle,this.settings.contentDisplayedFields=this.settings.contentDisplayedFields??l.contentDisplayedFields,this.settings.contentDisplayedFieldTypes=this.settings.contentDisplayedFieldTypes??l.contentDisplayedFieldTypes,this.settings.contentDisplayedFieldMappingData=this.settings.contentDisplayedFieldMappingData??l.contentDisplayedFieldMappingData,this.settings.contentDisplayedFieldFilters=this.settings.contentDisplayedFieldFilters??l.contentDisplayedFieldFilters,this.settings.showDataPanel=this.settings.showDataPanel??l.showDataPanel,this.settings.dataPanelDCs=this.settings.dataPanelDCs??l.dataPanelDCs}get datacollection(){const e=(this.settings||{}).datacollectionID;return this.AB.datacollectionByID(e)}getValueFields(e){return e?.connectFields((e=>"many"==e.linkType()&&"one"==e.linkViaType()))??[]}valueFields(){let e=(this.settings?.fields??"").split(",");Array.isArray(e)||(e=[e]);const t=[];let i=this.datacollection?.datasource;return e.forEach((e=>{if(!e)return;const a=i?.fieldByID?.(e);a&&(t.push(a),i=a.datasourceLink)})),t}});var a;const n=function(e){return class extends e{constructor(e,t,i){super(e,t||`ABViewOrgChart_${e.id}`,Object.assign({chartView:"",chartContent:"",chartHeader:"",dataPanel:"",dataPanelButton:"",dataPanelPopup:"",filterButton:"",filterPopup:"",filterForm:"",contentForm:"",contentFormData:"",teamForm:"",teamFormCode:"",teamFormPopup:"",teamFormStrategy:"",teamFormSubmit:"",teamFormTitle:""},i)),this._resources=[s.e(556).then(s.bind(s,556)),s.e(702).then(s.bind(s,702)),s.e(709).then(s.bind(s,709))],this.__filters={inactive:0},this._OrgChart=null,this._resolveInit=null,this._promiseInit=new Promise((e=>{this._resolveInit=e})),this._promisePageData=null,this._contentDC=null,this._contentGroupDC=null,this._contentDisplayDCs=[],this._dataPanelDCs=[],this._entityDC=null,this._chartData=null,this._fnContentDragEnd=e=>{},this._fnContentDragOver=e=>{e.preventDefault(),e.stopPropagation()},this._fnContentDragStart=e=>{e.stopPropagation();const t=e.target,i=t.dataset,a=e.dataTransfer,n={};"webix_list_item"===t.className?(n.pk=i.pk,n.contentLinkedFieldID=i.contentLinkedFieldId):n.source=i.source,a.setData("text/plain",JSON.stringify(n))},this._fnContentDrop=async e=>{const t=this.view.settings,i=1===t.dropContentToCreate,a=this.view.datacollection?.datasource,n=a.PK(),s=a.fieldByID(t.contentField)?.fieldLink,o=s?.object,l=o?.fieldByID(t.contentFieldDateStart)?.columnName,r=o?.fieldByID(t.contentFieldDateEnd)?.columnName,d=o?.fieldByID(t.contentGroupByField),c=d?.columnName,h=s?.columnName,u=o?.model(),p=e.dataTransfer;if(1==p.getData("isnode"))return;if(e.stopPropagation(),null==h)return;this.busy();const g=e.currentTarget,m=g.parentElement,y=g.dataset.pk,b=JSON.parse(m.parentElement.dataset.source)._rawData[n];let{source:f,pk:w,contentLinkedFieldID:D}=JSON.parse(p.getData("text/plain"));const C=[];let v=!0;try{if(f){f=JSON.parse(f);const e=m.getElementsByClassName("team-group-record"),t=this._dataPanelDCs;for(const i of t){const t=i.datasource.connectFields((e=>e.datasourceLink===o))[0].columnName;for(const i of e){const e=JSON.parse(i.dataset.source);if(f.id!=e.id&&e[t]==f[t]||f.id==e.id&&f[c]==g.dataset.pk)return void this.ready()}}const a=document.querySelector(`#${this.contentNodeID(f.id)}`);if(a.parentNode.removeChild(a),g.querySelector(".team-group-content").appendChild(a),C.push(a),delete f.created_at,delete f.updated_at,delete f.properties,this._setUpdatedBy(o,f),!i||f[h]==b&&this._isLessThanDay(new Date(f[l])))f[h]=b,f[c]=y,await u.update(f.id,this._parseFormValueByType(o,f,f));else{const e=[];f[r]=new Date,e.push(u.update(f.id,this._parseFormValueByType(o,f,f))),f[l]=f[r],delete f.id,delete f.uuid,delete f[r],f[h]=b,f[c]=y,e.push(u.create(this._parseFormValueByType(o,f,f))),await Promise.all(e)}}else{const e=o.fieldByID(D).columnName,t=[],i=new Date,a=m.getElementsByClassName("team-group-record");let n=!1;for(const s of a){const a=JSON.parse(s.dataset.source);if(a[e]==w){if(this._setUpdatedBy(o,a),!n){if(a[c]==y){v=!1,n=!0;continue}if(this._isLessThanDay(new Date(a[l]))){a[c]=this._parseDataPK(y),t.push(u.update(a.id,this._parseFormValueByType(o,a,a))),C.push(s),v=!0,n=!0;continue}}a[r]=i,t.push(u.update(a.id,this._parseFormValueByType(o,a,a))),C.push(s),v=!0}}if(!n){f={},f[l]=i,f[e]=this._parseDataPK(w),f[h]=this._parseDataPK(b),f[c]=this._parseDataPK(y);const a=this._entityDC;if(a){const e=a.datasource.connectFields((e=>e.settings.linkObject===o.id))[0].id,t=this.AB.definitionByID(e).columnName;f[t]=this._parseDataPK(a.getCursor())}this._setUpdatedBy(o,f),t.push(u.create(this._parseFormValueByType(o,f,f)),(async()=>{const e=await this._createUIContentRecord(f,"grey");g.querySelector(".team-group-content").appendChild(e),C.push(e)})())}await Promise.all(t)}}catch(e){console.log(e)}if(v){try{await Promise.all([this._reloadDCData(this.datacollection),this._reloadDCData(this._contentDC)])}catch(e){console.error(e)}await this.refresh(),C.forEach((e=>{e.remove()})),this.ready()}else this.ready()},this._fnCreateNode=async(e,t)=>{e.querySelector(".title > i")?.remove();const i=e.children.item(1);i.innerHTML="";const a=this._contentGroupDC,n=a.datasource.PK();await this._waitDCReady(a);const s=a.getData(),o=s.length;if(t.filteredOut||0===o)return void(i.style.display="none");const l=this.settings,r=d("div","spacer");i.appendChild(r);const c=r.style;c.backgroundColor="";for(const e of s){const t=d("div","team-group-section");i.appendChild(t);const a=t.style;a.minHeight=325/o+"px";const s="Leader"===e.name?"#003366":"#DDDDDD";a.backgroundColor=s,""===c.backgroundColor&&(c.backgroundColor=s);const r=e.name;if(t.setAttribute("data-pk",e[n]),1===l.showGroupTitle){const e=d("div","team-group-title");e.style.backgroundColor=s,e.appendChild(document.createTextNode(r)),t.appendChild(e)}const h=d("div","team-group-content");t.appendChild(h),1===l.draggable&&(t.addEventListener("dragover",this._fnContentDragOver),t.addEventListener("drop",this._fnContentDrop))}const h=d("div","team-button-section");i.appendChild(h);const u=d("div","team-button");u.append(d("i","fa fa-pencil"));const p=d("div","team-button");p.append(d("i","fa fa-plus")),h.append(u,p);const g=this.teamRecordID(t.id),m=this.datacollection.getData((e=>e.id==g))[0];if(p.onclick=()=>{this.teamForm("Add",{__parentID:g})},u.onclick=()=>this.teamForm("Edit",m),e.querySelector(".title").ondblclick=()=>this.teamForm("Edit",m),this.teamCanDelete(m)){const e=d("div","team-button");e.append(d("i","fa fa-trash")),e.onclick=()=>this.teamDelete(m),h.append(e)}if(1==this.__filters.inactive){const e=t.isInactive,i=d("div","team-button "+(e?"is-inactive":"is-active")),a=d("span","active-text");a.innerHTML=e?"INACTIVE":"ACTIVE",i.append(a),h.append(i)}},this._fnNodeDrop=async e=>{const t=e.detail,i=JSON.parse(t.draggedNode.dataset.source)._rawData;i[this.AB.definitionByID(this.getSettingField("teamLink").settings.linkColumn).columnName]=JSON.parse(t.dropZone.dataset.source)._rawData.id;const a=this.datacollection;this.busy(),this._setUpdatedBy(a.datasource,i);try{await a.model.update(i.id,i)}catch(e){console.error(e)}try{await Promise.all([this._reloadDCData(a),this._reloadDCData(this._contentDC)])}catch(e){console.error(e)}await this.refresh(),this.ready()},this._fnPageContentCallback=(e,t,i,a)=>{const n=this.AB.definitionByID(this.getSettingField("contentField").settings.linkColumn).columnName;for(const t of e){const e=document.getElementById(this.teamNodeID(t[n]));null!=e&&this._addContentRecordToGroup(e,t)}$$(this.ids.dataPanel)?.getChildViews()[1].getChildViews().forEach((e=>e.callEvent("onViewShow"))),t?a():this._callPagingEvent(i,this._fnPageContentCallback,a)},this._fnPageContentGroupCallback=async(e,t,i,a)=>{const n=this.datacollection;this._fnPageTeamCallback(n.getData(),!0,n,(()=>{})),t?a():this._callPagingEvent(i,this._fnPageContentGroupCallback,a)},this._fnPageContentDisplayCallback=(e,t,i,a)=>{const n=this._contentDC;this._fnPageContentCallback(n.getData(),!0,n,(()=>{})),t?a():this._callPagingEvent(i,this._fnPageContentDisplayCallback,a)},this._fnPageData=async(e,t,i)=>{await this._waitDCReady(e);let a=e.getData();try{if(a.length<20&&await e.loadData(),a=e.getData(),a.length<20||(a.length-20)%20>0)throw null;try{await e.loadData(20*parseInt(a.length/20),20)}catch{}if(e.getData().length===a.length)throw null;if(a=e.getData(),(a.length-20)%20>0)throw null;t&&await t(a,!1,e,i)}catch{t&&await t(a,!0,e,i)}},this._fnPageTeamCallback=async(e,t,i,a)=>{const n=this.getSettingField("contentField").columnName,s=this._contentDC,o=s.datasource.PK();for(const t of e){const e=this.teamNodeID(t.id);let i=document.getElementById(e);if(null==i){if(await this.teamAddChild(t,!1),i=document.getElementById(e),null==i)continue}else await this.teamEdit(t,!1);const a=s.getData((e=>t[n].indexOf(e[o])>-1));for(const e of a)this._addContentRecordToGroup(i,e)}t?(await this.pullData(),a()):this._callPagingEvent(this.datacollection,this._fnPageTeamCallback,a)},this._fnRefresh=async()=>{this.busy();const e=this._entityDC,t=this.datacollection,i=this._contentDC,a=this._contentGroupDC;await Promise.all([null!=t?.datacollectionLink&&this._waitDCPending(t),null!=i?.datacollectionLink&&this._waitDCPending(i),null!=a?.datacollectionLink&&this._waitDCPending(a),...this._contentDisplayDCs.filter((n=>n!==e&&n!==t&&n!==i&&n!==a)).map((e=>null!=e.datacollectionLink&&this._waitDCPending(e)))]),this.__orgchart?.remove(),this.__orgchart=null,await this.refresh(),this.ready()},this._fnShowContentForm=e=>{const t=this._contentDC,i=t.datasource,a=t.model,n=this.settings,s=n.editContentFieldsToCreateNew,o=i.fields((e=>e.id===n.contentFieldDateStart))[0],l=o?.label,r=o?.columnName,d=this.getSettingField("contentFieldDateEnd")?.columnName,c=JSON.parse(e.currentTarget.dataset.source||e.currentTarget.parentElement.dataset.source),h={},u=200,p=this.ids,g=n.setEditableContentFields.map((e=>{const t=i.fields((t=>t.id===e))[0];if(null==t)return{view:"label",label:this.label("Missing Field"),labelWidth:u};const a=t.key,n=t.columnName;let s="";n===d?(s=`The ${t.label} must be later than the ${l}.`,h[n]=e=>e>$$(p.contentFormData).getValues()[r]||""===e||null==e):h[n]=()=>!0;const o=t.label,g=t.settings;switch(a){case"boolean":return{view:"checkbox",name:n,label:o,labelWidth:u,invalidMessage:s};case"number":return{view:"counter",name:n,label:o,labelWidth:u,type:"number",invalidMessage:s};case"list":return{view:1===g.isMultiple?"muticombo":"combo",name:n,label:o,labelWidth:u,options:g.options.map((e=>({id:e.id,value:e.text}))),invalidMessage:s};case"user":case"connectObject":const e=this.AB.Webix,i=t.datasourceLink;if("NS Employee Record"===o)return{view:"text",label:"Name",disabled:!0,labelWidth:u,invalidMessage:s,on:{async onViewShow(){e.extend(this,e.ProgressBar),this.showProgress({type:"icon"});try{this.setValue(i.displayData((await i.model().findAll({where:{glue:"and",rules:[{key:i.PK(),rule:"equals",value:c[n]}]}})).data[0])),this.hideProgress()}catch{}}}};const l=async function(){e.extend(this,e.ProgressBar),this.showProgress({type:"icon"});try{this.define("options",(await i.model().findAll()).data.map((e=>({id:e.id,value:i.displayData(e)})))),this.refresh(),this.enable(),this.hideProgress()}catch{}};return"one"===t.linkType()?{view:"combo",name:n,label:o,disabled:!0,labelWidth:u,invalidMessage:s,options:[],on:{onViewShow:l}}:{view:"multicombo",name:n,label:o,labelWidth:u,stringResult:!1,labelAlign:"left",invalidMessage:s,options:[],on:{onViewShow:l}};case"date":case"datetime":return{view:"datepicker",name:n,label:o,stringResult:!0,labelWidth:u,invalidMessage:s,timepicker:"datetime"===a};case"file":case"image":return{name:n,label:o,labelWidth:u,invalidMessage:s};default:return{view:"text",name:n,label:o,labelWidth:u,invalidMessage:s}}})),m=AB.Webix;g.push({view:"button",value:this.label("Save"),css:"webix_primary",click:async()=>{const e=$$(p.contentFormData);if(!e.validate())return;const t=this._parseFormValueByType(i,c,e.getValues()),n=$$(p.contentForm);if(n.blockEvent(),n.$view.remove(),n.destructor(),!this._checkDataIsChanged(c,t))return;const o=this.datacollection,l=this._contentDC,h=t.id,u=document.getElementById(this.contentNodeID(h));if(delete t.created_at,delete t.updated_at,delete t.properties,this._setUpdatedBy(i,t),!this._isLessThanDay(new Date(c[r]))){let e=!1;for(const a of s){const n=i.fieldByID(a)?.columnName;if(!e&&null!=c[n]&&""!==c[n]&&JSON.stringify(t[n]??"")!==JSON.stringify(c[n])){e=!0;break}}if(e)return void m.confirm({title:this.label("Caution: Creating New Assignment"),ok:this.label("Continue with new assignment"),cancel:this.label("Cancel"),text:this.label("When you change the Role type or Job title, then the current assignment is closed with the current date and a new assignment is created for this team."),css:"orgchart-teams-edit-content-confirm-popup"}).then((async()=>{this.busy();const e=[],n={};n[d]=new Date,this._setUpdatedBy(i,n),e.push(a.update(h,n)),t[r]=n[d],delete t.id,delete t.uuid,delete t[d],e.push(a.create(t));try{await Promise.all(e)}catch(e){console.error(e)}try{await Promise.all([this._reloadDCData(o),this._reloadDCData(l)])}catch(e){console.error(e)}await this.refresh(),u.remove(),this.ready()}))}if(new Date(t[d])<=new Date)m.confirm({title:this.label("Caution: Ending Current Assignment"),ok:this.label("Continue with ending this assignment"),cancel:this.label("Cancel"),text:[this.label("When you provide an End Date, the current assignment is ended when the date = the current date and the assignment will no longer show on this team."),this.label("This will put the team member back into the unassigned list box if they have no other active assignments.")].join("\n"),css:"orgchart-teams-edit-content-confirm-popup"}).then((async()=>{this.busy();try{await a.update(h,t)}catch(e){console.error(e)}try{await Promise.all([this._reloadDCData(o),this._reloadDCData(l)])}catch(e){console.error(e)}await this.refresh(),u.remove(),this.ready()}));else{this.busy();try{await a.update(h,t)}catch(e){console.error(e)}try{await Promise.all([this._reloadDCData(o),this._reloadDCData(l)])}catch(e){console.error(e)}await this.refresh(),u.remove(),this.ready()}}}),m.ui({view:"popup",id:p.contentForm,close:!0,position:"center",css:{"border-radius":"10px"},body:{width:600,rows:[{view:"toolbar",css:"webix_dark",cols:[{width:5},{view:"label",label:`${this.label("Edit")} ${i.label}`,align:"left"},{view:"icon",icon:"fa fa-times",align:"right",width:60,click:()=>{const e=$$(p.contentForm);e.blockEvent(),e.$view.remove(),e.destructor()}}]},{view:"form",id:p.contentFormData,hidden:!0,elements:g,rules:h}]},on:{onHide(){this.$view.remove(),this.destructor()}}}).show();const y=$$(p.contentFormData);y.setValues(this._convertToFormValueByType(structuredClone(c))),y.show()},this._fnShowFilterPopup=async e=>{const t=this.settings.contentDisplayedFieldFilters,i=this.ids;let a=$$(i.filterPopup);if(!a){const e=this;a=webix.ui({view:"popup",css:"filter-popup",id:i.filterPopup,body:{rows:[{view:"form",borderless:!0,hidden:!0,id:i.filterForm,elements:[{view:"text",label:this.label("Team Name"),labelWidth:100,name:"teamName",clear:!0},{view:"combo",label:this.label("Strategy"),labelWidth:100,options:[],name:"strategy",clear:"replace",on:{async onViewShow(){webix.extend(this,webix.ProgressBar),this.showProgress({type:"icon"});try{this.define("options",await e.strategyCodeOptions()),this.refresh(),this.enable(),this.hideProgress()}catch{}}}},{view:"checkbox",name:"inactive",labelRight:this.label("Show Inactive Teams"),labelWidth:0},...(()=>{const e=[];for(const i in t){const[,a,n,s]=i.split(".");if(1==s)if("96dc0d8d-7fb4-4bb1-8b80-a262aae41eed"===n){const s=this.AB.objectByID(a),o=s.model(),l=s.fieldByID(n).columnName;e.push({view:"combo",label:t[i],labelWidth:100,options:[],name:i,clear:"replace",on:{async onViewShow(){webix.extend(this,webix.ProgressBar),this.showProgress({type:"icon"});try{this.define("options",(await o.findAll()).data.map((e=>({id:e[l],value:e[l]})))),this.refresh(),this.enable(),this.hideProgress()}catch{}}}})}else e.push({view:"text",label:t[i],labelWidth:100,name:i,clear:!0})}return e})(),{cols:[{},{view:"icon",icon:"fa fa-check",css:"filter-apply",click:()=>this.filterApply()}]}]}]},on:{onShow(){$$(i.filterForm).show()},onHide(){$$(i.filterForm).hide()}}})}a.show($$(i.filterButton).$view)};const a=["org-chart .strategy-external .title{background:#989898 !important;}"],n=this.settings.strategyColors;for(let e in n)a.push(`org-chart .strategy-${e} .title{background:${n[e]} !important;}`);const o=document.createElement("style");o.innerHTML=a.join(""),document.getElementsByTagName("head")[0].appendChild(o),this.on("pageData",this._fnPageData)}_addContentRecordToGroup(e,t){const i=this._contentGroupDC,a=t[this.getSettingField("contentGroupByField").columnName],n=i.datasource.PK();if(null==i.getData((e=>e[n]==a))[0])return;const s=e.querySelector(`.team-group-section[data-pk="${a}"] > .team-group-content`);null!=s&&(async()=>{await this._callAfterRender((async()=>{const i=this.contentNodeID(t.id);let a=document.getElementById(i);for(;null!=a;)a.remove(),a=document.getElementById(i);s.appendChild(await this._createUIContentRecord(t,this.settings.strategyColors[e.classList.item(1).replace("strategy-","")]))}))})()}_convertToFormValueByType(e){const t=this._contentDC.datasource.fields();for(const i of t){const t=i.columnName,a=e[t];switch(i.key){case"boolean":if(!0===a)e[t]=1;else if(!1===a)e[t]=0;else{const i=parseInt(a);e[t]=isNaN(i)?0:i}break;case"date":case"datetime":e[t]=new Date(a)}}return e}async _createUIContentRecord(e,t){const i=d("div","team-group-record");i.setAttribute("id",this.contentNodeID(e.id)),i.setAttribute("data-source",JSON.stringify(e)),i.style.borderColor=t,i.addEventListener("dblclick",this._fnShowContentForm),1===this.settings.draggable&&(i.setAttribute("draggable","true"),i.addEventListener("dragstart",this._fnContentDragStart),i.addEventListener("dragend",this._fnContentDragEnd));const a=[d("div","display-block"),d("div","display-block"),d("div","display-block display-block-right")],n=d("div","team-group-record-display");let s=[],o=null,l=0;const r=this._contentDC.datasource.id,c=this.settings.contentDisplayedFields,h=Object.keys(c),u=this._contentDisplayDCs;for(let t=0;t<h.length;t++){const i=h[t],[p,g]=i.split("."),m=AB.objectByID(g),y=c[i],b=m.fieldByID(y),f=u.find((e=>e.datasource.id===g));switch(g){case r:s=[e];break;default:if(null==o)break;if(s.length>0){const e=o.columnName,t=[];do{const i=s.pop()[e];Array.isArray(i)?i.length>0&&t.push(...i):null!=i&&t.push(i)}while(s.length>0);await this._waitDCReady(f),s=f.getData((e=>t.some((t=>t==e.id))))}}if(h[t+1]?.split(".")[0]===p){o=b;continue}const w=d("div","team-group-record-display"),D=b.columnName;switch(l){case 0:a[0].appendChild(w);break;case 1:let e=0;for(;s.length>0&&null!=s[e];)null==s[e][D]||""===s[e][D]?s.splice(e,1):e++;0===s.length&&(a[2].style.display="none"),a[2].appendChild(w);break;case 2:a[1].appendChild(n),n.appendChild(w);break;case 3:n.appendChild(w);break;default:a[1].appendChild(w)}l++;const C=`${i}.${y}`,v=JSON.parse(this.settings.contentDisplayedFieldMappingData?.[C]||null)||{};switch(null!=this.settings.contentDisplayedFieldTypes[`${C}.0`]&&(w.style.display="none"),this.settings.contentDisplayedFieldTypes[`${C}.1`]){case"icon":break;case"image":for(;s.length>0;){const e=s.pop()[D],t=document.createElement("img");w.appendChild(t),t.setAttribute("src",v[e]??e)}break;case"svg":for(;s.length>0;){const e=s.pop(),t=e.id,i=e[D],a="http://www.w3.org/2000/svg",n="http://www.w3.org/1999/xlink",o=document.createElementNS(a,"svg");w.appendChild(o),o.setAttribute("viewBox","0 0 6 6"),o.setAttribute("fill","none"),o.setAttribute("xmlns",a),o.setAttribute("xmlns:xlink",n);const l=document.createElementNS(a,"rect"),r=document.createElementNS(a,"defs");o.append(l,r),l.setAttribute("width","6"),l.setAttribute("height","6");const d=`display-svg.pattern.${t}`;l.setAttribute("fill",`url(#${d})`);const c=document.createElementNS(a,"pattern"),h=document.createElementNS(a,"image");r.append(c,h),c.id=d,c.setAttributeNS(null,"patternContentUnits","objectBoundingBox"),c.setAttribute("width","1"),c.setAttribute("height","1");const u=`display-svg.image.${t}`;h.id=u,h.setAttribute("width","512"),h.setAttribute("height","512"),h.setAttributeNS(n,"xlink:href",v[i]??i);const p=document.createElementNS(a,"use");c.appendChild(p),p.setAttributeNS(n,"xlink:href",`#${u}`),p.setAttribute("transform","scale(0.002)")}break;default:for(;s.length>0;){const e=s.pop()[D];w.appendChild(document.createTextNode(v[e]??e))}l-1==1&&(w.textContent=w.textContent.slice(0,35))}o=null}const p=a.length;for(let e=0;e<p;e++){const t=a[e];i.appendChild(t);const n=t.children;let s,o,l,r=!1,d=0;if(1===e){for(s=n.item(d),o=s.children,l=o.length;d<l;d++)if("none"!==o[d].style.display){r=!0;break}if(r)continue;s.style.display="none",d=1}const c=n.length,h=t.style;for(;d<c;d++)if("none"!==n.item(d).style.display){r=!0;break}!r&&(h.display="none")}const g=d("div","team-group-record-edit-icon");return g.appendChild(d("i","fa fa-pencil")),g.addEventListener("click",this._fnShowContentForm),i.appendChild(g),i}async _callAfterRender(e,...t){await new Promise(((i,a)=>{requestAnimationFrame((()=>{requestAnimationFrame((async()=>{try{await e(...t),i()}catch(e){a(e)}}))}))}))}_callPagingEvent(e,t,i){this.emit("pageData",e,t,i)}_checkDataIsChanged(e,t){for(const i in t)if(JSON.stringify(t[i])!==JSON.stringify(e[i]))return!0;return!1}_isLessThanDay(e){return Math.abs(new Date-e)/36e5<24}_initDC(e){e.init(),e.dataStatus===e.dataStatusFlag.notInitial&&e.loadData()}_pageData(){if(null!=this._promisePageData)return;let e=null;this._promisePageData=new Promise((t=>{e=t}));const t=this._entityDC,i=this.datacollection,a=this._contentDC,n=this._contentGroupDC;(async()=>{try{await Promise.all([new Promise((e=>{this._callPagingEvent(i,this._fnPageTeamCallback,e)})),new Promise((e=>{this._callPagingEvent(a,this._fnPageContentCallback,e)})),new Promise((e=>{this._callPagingEvent(n,this._fnPageContentGroupCallback,e)})),...this._contentDisplayDCs.filter((e=>e!==t&&e!==i&&e!==a&&e!==n)).map((e=>new Promise((t=>{this._callPagingEvent(e,this._fnPageContentDisplayCallback,t)}))))])}catch(e){console.error(e)}e(),this._promisePageData=null})()}_parseDataPK(e){const t=parseInt(e);return(isNaN(t)||t.toString().length!==e.length)&&e||t}_parseFormValueByType(e,t,i){const a=e.fields();for(const e of a){const a=e.key,n=e.columnName,s=t?.[n],o=i[n];switch(a){case"date":void 0===s&&null==o?delete i[n]:(i[n]=new Date(o),isNaN(i[n])?delete i[n]:i[n]=`${i[n].getFullYear()}-${String(i[n].getMonth()+1).padStart(2,"0")}-${String(i[n].getDate()).padStart(2,"0")}`);break;case"datetime":void 0===s&&null==o&&delete i[n];try{o instanceof Date&&(i[n]=o.toISOString())}catch{delete i[n]}break;case"connectObject":if(delete i[`${n}__relation`],"one"===e.linkType())if(void 0===s&&null==i[n])delete i[n];else switch(typeof s){case"number":i[n]=parseInt(o)||null;break;case"string":i[n]=o?.toString()||null}else delete i[n];break;default:if(null==o||""===o){if(void 0===s){delete i[n];break}if(""===s){i[n]="";break}}switch(a){case"boolean":switch(typeof s){case"number":i[n]=o;break;case"string":i[n]=1===o?"1":"0";break;default:i[n]=1==o}break;case"number":const e=parseInt(o);if(isNaN(parseInt(o))){void 0===s?delete i[n]:i[n]=s;break}i[n]="string"==typeof s?e.toString():e;break;case"string":i[n]=o?.toString()||""}}}return i}async _reloadAllDC(){const e=this._entityDC,t=this.datacollection,i=this._contentDC,a=this._contentGroupDC;await Promise.all([this._reloadDCData(t),...this._dataPanelDCs.map((e=>this._reloadDCData(e))),this._reloadDCData(i),...this._contentDisplayDCs.filter((n=>n!==e&&n!==t&&n!==i&&n!==a)).map((e=>this._reloadDCData(e)))])}async _reloadDCData(e){await this._promisePageData,e.dataStatus===e.dataStatusFlag.initializing&&await this._waitDCReady(e),e.clearAll(),this._initDC(e),await this._waitDCReady(e)}_setUpdatedBy(e,t){t[e.fields((e=>e.columnName.indexOf("_last_upd_by_in_app")>-1||e.columnName.indexOf("_update_in_app")>-1))[0].columnName]=this.AB.Account.email()}_showDataPanel(){let e=$$(this.ids.dataPanelPopup);e||(e=this.AB.Webix.ui({id:this.ids.dataPanelPopup,view:"popup",width:250,body:this._uiDataPanel(),css:"data-panel-popup",modal:!0}));const t=$$(this.ids.dataPanelButton).$view,i=t.querySelector(".data-panel-button");this._resizeObserver||(this._resizeObserver=new ResizeObserver((([t])=>{if(0==t.contentRect.width&&0==t.contentRect.height)return e.hide();e.show(i,{x:-30,y:-35})}))),this._resizeObserver.observe(t),e.show(i,{x:-30,y:-35}),$$(this.ids.dataPanel).getChildViews()[1].getChildViews().forEach((e=>e.callEvent("onViewShow")))}_showOrgChart(){const e=this.settings,t=this.AB,i=1===e.draggable,a=this.ids,n=this._chartData;if(null==n)return void(this.__orgchart=null);const s=new this._OrgChart({data:t.cloneDeep(n),direction:e.direction,pan:!0,zoom:!1,draggable:i,parentNodeSymbol:!1,exportButton:e.export,exportFilename:e.exportFilename,createNode:this._fnCreateNode,nodeContent:"description"});if(i&&s.addEventListener("nodedropped.orgchart",this._fnNodeDrop),null!=this.__orgchart){const e=this.__orgchart;s.dataset.panStart=e.dataset.panStart,s.setAttribute("style",e.getAttribute("style")),e.remove()}$$(a.chartContent).$view.appendChild(this.__orgchart=s)}_uiDataPanel(){const e=this,t=e._dataPanelDCs,i=e.settings.dataPanelDCs,a=this._contentDC?.datasource?.id,n=[];for(const s in i){const[o,l]=s.split("."),r=e._contentDisplayDCs.find((e=>e.datasource.id===t.find((e=>e.id===l)).datasource.id)),d=this._contentDC,c=i[s];if(null==r)n.push({header:c,body:{view:"list",css:{overflow:"auto","max-height":"90%"},data:[]}});else{const i=r.datasource;n.push({header:c,body:{view:"list",template:e=>`<div class="data-panel-employee">${i.displayData(e)}</div>`,borderless:!0,css:"data-panel-employee-list",data:[],on:{async onViewShow(){await e._waitDCReady(r);const n=i.connectFields((e=>e.datasourceLink.id==a))[0].fieldLink,s=n.columnName;this.clearAll(),this.define("data",(parseInt(o)<2?r.getData((e=>"T"!==e.isinactive&&("0"===o?null==d.getData((t=>t[s]==e.id))[0]:null!=d.getData((t=>t[s]==e.id))[0]))):t.find((e=>e.id===l)).getData()).sort(h)),await e._callAfterRender((()=>{const t=this.$view.children.item(0).children,a=t.length,s=n.id;let o=0;for(;o<a;){const a=t.item(o++);a.setAttribute("data-content-linked-field-id",s);const n=r.getData((e=>e.id==a.getAttribute("webix_l_id")))[0];null!=n&&(a.setAttribute("data-pk",n[i.PK()]),a.setAttribute("draggable","true"),a.addEventListener("dragstart",e._fnContentDragStart),a.addEventListener("dragend",e._fnContentDragEnd))}}))}}}})}}return{height:600,type:"clean",rows:[{view:"template",borderless:!0,template:`<div style="color:#2F27CE;font-family:'Roboto';font-size:17px;font-weight:900">\n                     ${this.label("Staff Assignment")}\n                     <span class="fa fa-compress data-panel-close"></span>\n                  </div>`,height:35,onClick:{"data-panel-close":()=>($$(this.ids.dataPanelPopup).hide(),this._resizeObserver?.unobserve($$(this.ids.dataPanelButton).$view),!1)}},{id:this.ids.dataPanel,view:"tabview",css:"data-panel-tabview",width:250,borderless:!0,tabbar:{height:25,align:"left",css:"data-panel-tabbar"},cells:n}]}}async _waitDCPending(e){switch(e.dataStatus){case e.dataStatusFlag.notInitial:case e.dataStatusFlag.initialized:await new Promise((t=>{e.once("initializingData",t)}))}}async _waitDCReady(e){const t=e.dataStatusFlag;switch(e.dataStatus){case t.notInitial:case t.initializing:await new Promise((t=>{e.once("initializedData",t)}))}}ui(){const e=this,t=e.ids,i=e.AB.Webix,a=super.ui([{id:t.chartView,responsive:!0,type:"clean",rows:[{responsive:!0,id:t.chartHeader,view:"toolbar",height:50,type:"clean",cols:[{view:"template",id:this.ids.filterButton,template:`<button class="filter-button">\n                              <i class="fa fa-filter"></i> ${e.label("Filter")}</button>`,align:"left",onClick:{"filter-button":t=>e._fnShowFilterPopup(t)}},{view:"template",id:this.ids.dataPanelButton,template:`<div class="data-panel-button">\n                              <span class="fa fa-2x fa-users"></span>\n                              <div class="data-panel-open">\n                                 ${e.label("Staff Assignment")}\n                                 <span class="fa fa-expand" style="float:right;"></span>\n                              </div>\n                           </div>`,align:"right",onClick:{"data-panel-open":t=>e._showDataPanel(t)}}]},{responsive:!0,id:t.chartContent,view:"template",scroll:"auto",on:{onAfterRender(){i.extend(this,i.ProgressBar)}}}]}]);return delete a.type,a}async init(e,t){await super.init(e,t);const i=this.settings;this._resources=await Promise.all(this._resources),this._OrgChart||(this._OrgChart=(()=>{const e=this._resources[0].default,t=e.prototype._onDragStart;return e.prototype._onDragStart=e=>{e.dataTransfer.setData("isnode",1),null!=this.__orgchart&&t.call(this.__orgchart,e)},e})());const a=(()=>{const e=this._entityDC;return null!=e&&this._initDC(e),e})()||(this._entityDC=await(async()=>{const e=this.AB.datacollectionByID(i.entityDatacollection);return null!=e&&(this._initDC(e),await Promise.all([this._waitDCReady(e),new Promise((t=>{const i="changeCursor";e.off(i,this._fnRefresh),null!=e.getCursor()?(e.on(i,this._fnRefresh),t()):e.once(i,(()=>{e.on(i,this._fnRefresh),t()}))}))])),e})());if(1===i.showDataPanel){const t=this._dataPanelDCs,a=i.dataPanelDCs;for(const i in a){const[,a]=i.split("."),n=e.datacollectionByID(a);t.findIndex((e=>e.id===a))<0&&t.push(n),this._initDC(n)}}const n=this._contentDC||(this._contentDC=(()=>{const t=this.AB.objectByID(this.getSettingField("contentField").settings.linkObject),n=t.id,s=JSON.parse(i.contentFieldFilter),o={datasourceID:n,linkDatacollectionID:null,linkFieldID:null,objectWorkspace:{filterConditions:{glue:"and",rules:[{key:t.fieldByID(i.contentFieldDateStart)?.id,rule:"is_not_null",value:""},{glue:"or",rules:s.rules?.length>0&&[s,{key:t.fieldByID(i.contentFieldDateEnd)?.id,rule:"is_null",value:""}]||[]}]}}};if(null!=a){const e=a.datasource.id;(o.linkFieldID=t.connectFields((t=>t.settings.linkObject===e))[0]?.id)&&(o.linkDatacollectionID=a.id)}const l=e.datacollectionNew({id:`dc.${n}`,settings:o});return l.$dc.__prevLinkDcCursor=a?.getCursor()?.id?.toString(),this._initDC(l),l})()),s=this._contentGroupDC||(this._contentGroupDC=(()=>{const e=n.datasource.fieldByID(i.contentGroupByField).settings.linkObject,t={datasourceID:e,linkDatacollectionID:null,linkFieldID:null};if(null!=a){const i=a.datasource.id;(t.linkFieldID=this.AB.objectByID(e).connectFields((e=>e.settings.linkObject===i))[0]?.id)&&(t.linkDatacollectionID=a.id)}const s=this.AB.datacollectionNew({id:`dc.${e}`,settings:t});return s.$dc.__prevLinkDcCursor=a?.getCursor()?.id?.toString(),this._initDC(s),s})()),o=Object.keys(i.contentDisplayedFields);if(o.length>0){const t=this.datacollection,i=t.datasource.id,l=n.datasource.id,r=s.datasource.id,d={datasourceID:null,linkDatacollectionID:null,linkFieldID:null,fixSelect:""},c=this._contentDisplayDCs;let[,h]=o.pop().split(".");for(;o.length>0;){if(c.findIndex((e=>e.datasource.id===h))<0)switch(h){case i:this._initDC(t),c.push(t);break;case l:this._initDC(n),c.push(n);break;case r:c.push(s),this._initDC(s);break;default:if(a?.datasource.id===h)this._initDC(a),c.push(a);else{if(d.datasourceID=h,null!=a){const t=a.datasource.id;(d.linkFieldID=e.objectByID(h).connectFields((e=>e.settings.linkObject===t))[0]?.id)&&(d.linkDatacollectionID=a.id)}const t=e.datacollectionNew({id:`dc.${h}`,settings:d});t.$dc.__prevLinkDcCursor=a?.getCursor()?.id?.toString(),this._initDC(t),c.push(t)}}[,h]=o.pop().split(".")}}this._resolveInit()}getChartData(e,t=this._chartData){if(this.teamNodeID(e)===t.id)return t;if(t.children?.length>0)for(let i of t.children)if(i=this.getChartData(e,i),null!=i)return i}async onShow(){this.busy(),this.AB.performance.mark("TeamChart.onShow"),await this._promiseInit,super.onShow(),this.AB.performance.mark("TeamChart.load"),await this.refresh(),this.AB.performance.measure("TeamChart.load"),this.AB.performance.measure("TeamChart.onShow"),this.ready()}async pullData(){this._chartData=null;const e=this.datacollection;if(null==e)return;const t=this.settings;await this._waitDCReady(e);let i=e.getCursor();const a=this.getSettingField("topTeam").columnName;if(t.topTeam&&(i=e.getData((e=>1==e[a]))[0]||i),!i)return;const n=this.getSettingField("teamLink"),s=n.columnName,o=this.AB.definitionByID(n.settings.linkColumn).columnName,l=(t,i=0)=>{i>=10||(t.children=[],t._rawData[this.getSettingField("teamLink").columnName].forEach((a=>{const n=e.getData((e=>e.id==a))[0];if(!n||n[o]==a||0==this.__filters?.inactive&&n[this.getSettingField("teamInactive").columnName])return;const r={name:n[this.getSettingField("teamName").columnName],id:this.teamNodeID(a),className:`strategy-${n[`${this.getSettingField("teamStrategy").columnName}__relation`]?.[this.getSettingField("strategyCode").columnName]}`,isInactive:n[this.getSettingField("teamInactive").columnName],_rawData:n};r.filteredOut=this.filterTeam(r),"External Support"===r.name&&(r.className="strategy-external"),n[s].length>0&&l(r,i+1),(!r.filteredOut||r.children?.length>0)&&t.children.push(r)})),0===t.children.length?delete t.children:t.children=t.children.sort(h))},r=this._chartData={id:this.teamNodeID(i.id),name:i[this.getSettingField("teamName").columnName]??"",className:`strategy-${i[`${this.getSettingField("teamStrategy").columnName}__relation`]?.[this.getSettingField("strategyCode").columnName]}`,isInactive:i[this.getSettingField("teamInactive").columnName],_rawData:i,filteredOut:!1};r.filteredOut=this.filterTeam(r),l(r)}async refresh(e=!0){const t=this.ids;$$(t.teamFormPopup)?.destructor(),$$(t.contentForm)?.destructor(),await this.pullData(),this._showOrgChart(),e&&this._pageData()||await this._callAfterRender((()=>{const e=this._contentDC;this._fnPageContentCallback(e.getData(),!0,e,(()=>{}))}))}async filterApply(){this.busy(),await this._promisePageData;const e=this.ids;$$(e.filterPopup).hide(),this.__filters=$$(e.filterForm).getValues(),this.__orgchart?.remove(),this.__orgchart=null,await this.refresh(!1),this.ready()}filterTeam(e){const t=this.__filters;let i=!1;if(t.strategy=t.strategy??"",t.teamName=t.teamName??"",(t.strategy||t.teamName)&&(i=!0,""!==t.strategy&&t.strategy==e.className.replace("strategy-","")&&(i=!1),""!==t.teamName&&e.name.toLowerCase().includes(t.teamName.toLowerCase())&&(i=!1),!i))return i;const a=this.AB,n=this.settings,s=n.contentDisplayedFieldFilters;for(const e in s)t[e]=t[e]??"",""!==t[e]&&(i=!0);if(!i)return i;const o=n.contentField,l=this.datacollection.datasource,r=l.connectFields((e=>e.id===o))[0].fieldLink.columnName,d=this._contentDC,c=d.datasource,h=c.id,u=c.PK(),p=e._rawData[l.PK()],g=n.contentDisplayedFields,m=Object.keys(g),y=this._contentDisplayDCs;let b=null,f=null,w=null,D=null,C=null,v=null,_=[];for(;m.length>0;){if(b=m.pop(),w=b.split(".")[1],v=t[`${b}.${g[b]}.0`],null==v&&(v=t[`${b}.${g[b]}.1`]),null!=v){if(""===v)continue;v=v.toString().toLowerCase(),C=a.definitionByID(g[b]).columnName,f=y.find((e=>e.datasource.id===w)),D=f.datasource.PK(),_=f.getData((e=>e[C]?.toString().toLowerCase().indexOf(v)>-1)).map((e=>e[D]?.toString()))}else _.length>0&&(C=a.definitionByID(g[b]).columnName,f=y.find((e=>e.datasource.id===w)),D=f.datasource.PK(),_=f.getData((e=>{const t=e[C];return Array.isArray(t)?t.findIndex((e=>_.indexOf(e.toString())>-1))>-1:_.indexOf(t?.toString())>-1})).map((e=>e[D].toString())));if(w===h&&_.length>0&&d.getData((e=>e[r]==p)).findIndex((e=>_.indexOf(e[u].toString())>-1))>-1){i=!1;break}}return i}getSettingField(e){return this.AB.definitionByID(this.settings[e])}async teamAddChild(e,t=!0,i=[]){const a=this._entityDC,n=this.datacollection,s=n.datasource,o=s.id;if(a){const i=t&&a.datasource.connectFields((e=>e.settings.linkObject===o))[0];if(i){const t=a.getCursor();e[this.AB.definitionByID(i.settings.linkColumn).columnName]=t}}let l=e;if(t){this.busy(),this._setUpdatedBy(s,e);try{l=await n.model.create(e)}catch(e){console.error(e)}this.ready()}if(0==this.__filters?.inactive&&(null==l||l[this.getSettingField("teamInactive").columnName]))return;const r=document.querySelector(`#${this.teamNodeID(l[this.AB.definitionByID(this.getSettingField("teamLink").settings.linkColumn).columnName])}`);if(null==r)return;const d=r.parentNode.colSpan>1,c=l.id,h={name:l[this.getSettingField("teamName").columnName],filteredOut:!1,isInactive:l[this.getSettingField("teamInactive").columnName],id:this.teamNodeID(c),relationship:d?"110":"100",className:`strategy-${l[`${this.getSettingField("teamStrategy").columnName}__relation`]?.[this.getSettingField("strategyCode").columnName]}`,_rawData:l};h.filteredOut=this.filterTeam(h),d?this.__orgchart.addSiblings(this.closest(r,(e=>"TABLE"===e.nodeName)).querySelector(".nodes").querySelector(".node"),{siblings:[h]}):this.__orgchart.addChildren(r,{children:[h]}),await this.refresh(t)}teamCanInactivate(e){const t=this.getSettingField("teamInactive").columnName;return!!e[t]||!!e[this.getSettingField("teamCanInactivate").columnName]&&!(e[this.getSettingField("teamLink").columnName].some((e=>0==this.datacollection.getData((t=>t.id==e))[0]?.[t]))||document.getElementById(this.teamNodeID(e.id)).querySelectorAll(".team-group-record").length>0)}teamCanDelete(e){return e[this.getSettingField("teamCanInactivate").columnName]&&0===e[this.getSettingField("teamLink").columnName].length&&0===e[this.getSettingField("contentField").columnName].length}teamDelete(e,t=!0){if(!this.teamCanDelete(e))return void this.AB.Webix.message({text:"This team cannot be deleted",type:"error",expire:1001});const i=this.teamNodeID(e.id);document.querySelector(`#${i}`).querySelectorAll(".team-group-record").length>0?this.AB.Webix.alert({text:this.label("Since there are assignments or teams associated with this team, this action cannot be done until all of its assignments are made inactive")}):this.AB.Webix.confirm({text:this.label("This will permanently remove this team. Click OK to continue or Cancel to not remove the team.")}).then((()=>{t&&this.datacollection.model.delete(e.id),this.__orgchart.removeNodes(document.querySelector(`#${i}`))}))}async teamEdit(e,t=!0){let i=e;const a=this.datacollection,n=a.datasource;if(t){this.busy(),this._setUpdatedBy(n,e);try{i=await a.model.update(e.id,e)}catch(e){console.error(e)}this.ready()}const s=document.querySelector(`#${this.teamNodeID(i.id)}`);if(0==this.__filters?.inactive&&i[this.getSettingField("teamInactive").columnName])return void this.__orgchart.removeNodes(s);const o=JSON.parse(s.dataset.source),l=n.fieldByID(this.getSettingField("teamLink").settings.linkColumn).columnName;if(o._rawData[l]!=i[l])return void await this.refresh(t);const r=s.classList?.value?.match(/strategy-\S+/)[0],d=i[`${this.getSettingField("teamStrategy").columnName}__relation`]?.[this.getSettingField("strategyCode").columnName],c=d&&`strategy-${d}`||r;r!==c&&(s.classList?.remove(r),s.classList?.add(c));const h=i[this.getSettingField("teamName").columnName];s.querySelector(".title").innerHTML=h;const u={className:c,filteredOut:!1,id:this.teamNodeID(i.id),isInactive:i[this.getSettingField("teamInactive").columnName],name:h,relationship:o.relationship,_rawData:i};u.filteredOut=this.filterTeam(u),s.dataset.source=JSON.stringify(u),t&&await this.refresh(t)}async teamForm(e,t){const i=this.datacollection.datasource,a=this.ids,n=this.settings,s=i.fieldByID(n.teamName),o=this._entityDC,l=o.datasource.id,r=o.getCursor().id,d=i.fieldByID(n.teamStrategy),c=i.fieldByID(this.getSettingField("teamLink").settings.linkColumn),h=c.columnName,u="Edit"===e,p={glue:"and",rules:[{key:i.connectFields((e=>e.settings.linkObject===l))[0].columnName,value:r,rule:"equals"},{key:i.PK(),rule:"not_equal",value:t.id}]},g=this,m=110,y=webix.ui({view:"popup",id:a.teamFormPopup,close:!0,position:"center",width:400,css:{"border-radius":"10px"},body:{rows:[{view:"toolbar",css:"webix_dark",cols:[{width:5},{view:"label",label:`${this.label(e)} Team`,align:"left"},{view:"icon",icon:"fa fa-times",align:"right",width:60,click:()=>{y.blockEvent(),y.$view.remove(),y.destructor()}}]},{view:"form",id:a.teamForm,hidden:!0,borderless:!0,elements:[{view:"text",label:s.label,labelWidth:m,name:s.columnName,required:!0},{view:"richselect",label:this.label("Strategy"),labelWidth:m,id:this.ids.teamFormCode,options:[],required:!0,on:{async onViewShow(){webix.extend(this,webix.ProgressBar),this.showProgress({type:"icon"});try{this.disable(),this.define("options",await g.strategyCodeOptions()),this.refresh(),this.enable(),this.hideProgress()}catch{}},async onChange(e,t){if(e===t)return;const i=await g.strategyOptions(e),a=$$(g.ids.teamFormStrategy);a.define?.("options",i),a.refresh(),a.enable()}}},{view:"richselect",label:this.label("Sub Strategy"),labelWidth:m,name:d.columnName,id:this.ids.teamFormStrategy,options:[],required:!0,on:{async onViewShow(){webix.extend(this,webix.ProgressBar),this.showProgress({type:"icon"});try{this.disable();const e=this.getValue();if(e){const{code:t}=(await g.strategyOptions()).find((t=>t.id===e)),i=g.strategyOptions(t);$$(g.ids.teamFormCode).setValue(t),this.define("options",i),this.refresh(),this.enable()}this.hideProgress()}catch{}}}},{view:"combo",label:c.label,labelWidth:m,name:h,options:[],required:!0,on:{async onViewShow(){webix.extend(this,webix.ProgressBar),this.showProgress({type:"icon"});try{this.disable(),this.define("options",(await c.getOptions(p)).map((e=>({id:e.id,value:i.displayData(e)})))),this.refresh(),u&&this.enable(),this.hideProgress()}catch{}}}},{view:"switch",disabled:!this.teamCanInactivate(t),name:this.getSettingField("teamInactive").columnName,label:"Inactive"},{view:"text",name:"id",hidden:!0},{id:a.teamFormSubmit,view:"button",value:this.label("Save"),disabled:!0,css:"webix_primary",click:async()=>{let e=$$(a.teamForm).getValues();if(e.id){const t=document.getElementById(this.teamNodeID(e.id)),a=JSON.parse(t.dataset.source)._rawData;if(e=this._parseFormValueByType(i,a,e),!this._checkDataIsChanged(a,e))return;this.teamEdit(e)}else this.teamAddChild(this._parseFormValueByType(i,null,e));y.blockEvent(),y.$view.remove(),y.destructor()}}],on:{onChange:()=>{const e=$$(a.teamForm).getValues();let t=!!e[d.columnName]&&!!e[s.columnName];u&&(t=t&&!!e[h]);const i=$$(a.teamFormSubmit);t?i.enable():i.disable()}}}]},on:{onShow(){$$(a.teamForm).show()},onHide(){this.$view.remove(),this.destructor()}}});t.__parentID&&(t[h]=t.__parentID,delete t.__parentID),$$(a.teamForm).setValues(t),y.show()}contentNodeID(e){return`contentnode_${e}`}async strategyCodeOptions(){if(!this._strategyCodeOpts){const e=this.getSettingField("teamStrategy").settings.linkObject,t=this.AB.objectByID(e),i=this.getSettingField("strategyCode").id,a=t.fields((e=>e.id===i))[0],n=await a.getOptions();this._strategyCodeOpts=n.map(c).sort()}return this._strategyCodeOpts}async strategyOptions(e){if(!this._strategyOpts){const e=this.datacollection.datasource.fieldByID(this.settings.teamStrategy),t=this.getSettingField("subStrategy").columnName,i=this.getSettingField("strategyCode").columnName,a=await e.getOptions(null,null,null,null,[t]);this._strategyOpts=a.map((e=>({id:e.id,value:e[`${t}__relation`].name,code:e[i]}))).sort()}return e?this._strategyOpts.filter((t=>t.code===e)):this._strategyOpts}teamNodeID(e){return`teamnode_${e}`}teamRecordID(e){return e.split("_")[1]}closest(e,t){return e&&(t(e)&&e!==document.querySelector(`#${this.ids.chartContent}`)?e:this.closest(e.parentNode,t))}busy(){const e=$$(this.ids.chartContent);e.disable(),e.showProgress({type:"icon"})}ready(){const e=$$(this.ids.chartContent);e.enable(),e.hideProgress()}}}(t);return class extends i{component(){return new n(this)}}}var p=null;function g(e,t){if(!p){const i=t(e);p=class extends i{static get key(){return"plugin_hr_teams"}constructor(e,t="interface_editor_viewOrgChartTeans"){super(e,t)}ui(){return super.ui()}init(e){return this.AB=e,super.init(e)}detatch(){this.component?.detatch?.()}onShow(){this.component?.onShow?.()}}}return p}function m(e,t){const i=t(e),a=e.Config.uiSettings(),n=i.L();return class extends i{constructor(){super("properties_abview_org_chart_teams",{datacollectionID:"",strategyCode:"",subStrategy:"",teamInactive:"",teamCanInactivate:"",teamLink:"",teamName:"",teamStrategy:"",topTeam:"",fields:"",direction:"",depth:"",draggable:"",dropContentToCreate:"",pan:"",zoom:"",height:"",export:"",exportFilename:"",groupByField:"",showGroupTitle:"",editContentFieldsToCreateNew:"",setEditableContentFields:"",contentField:"",contentFieldFilter:"",contentFieldDateStart:"",contentFieldDateEnd:"",contentFieldFilterButton:"",contentGroupByField:"",contentDisplayedFields:"",contentDisplayedFieldsAdd:"",contentDisplayedFieldFilters:"",contentDisplayedFieldFiltersSet:"",contentDisplayedFieldTypes:"",contentDisplayedFieldTypesSet:"",contentDisplayedFieldMappingData:"",contentDisplayedFieldMappingDataSet:"",showDataPanel:"",dataPanelDCs:"",dataPanelDCsAdd:"",strategyColorPopup:"",strategyColorForm:"",entityDatacollection:""}),this.AB=e;const t=this.contentFieldFilter=e.filterComplexNew(this.ids.contentFieldFilter);t.on("save",(()=>{t.isConditionComplete(t.getValue())||t.setValue({glue:"and",rules:[]}),this.onChange()}))}static get key(){return"plugin_hr_teams"}_uiDataPanelDC(e="",t=""){const i=this,s=i.ids,o=$$(s.dataPanelDCs),l=this.CurrentView.datacollection.datasource.fieldByID($$(s.contentField).getValue()).datasourceLink.connectFields((e=>"one"===e.linkType())).map((e=>e.datasourceLink.id)),r=this.AB.datacollections((e=>l.indexOf(e.datasource.id)>-1)).map((e=>({id:e.id,value:e.label,dc:e}))),d=(t,i)=>({view:"text",name:`${i}.${t}`,on:{onChange:()=>{this.onChange()},onViewShow(){this.setValue(e)}}});return{cols:[{view:"richselect",label:`${n("Panel")} ${o.getChildViews().length+1}`,labelWidth:a.labelWidthMedium,options:r,on:{onChange(e){const t=this.getParentView(),i=t.getChildViews();3===t.getChildViews().length&&t.removeView(i[1].config.id),t.addView(d(e,o.getChildViews().findIndex((e=>e===t))),1)},onViewShow(){null!=t&&""!==t&&this.setValue(t)}}},{view:"button",css:"webix_danger",type:"icon",icon:"wxi-close",width:a.buttonWidthExtraSmall,click(){i.deleteDataPanelDC(this.getParentView().config.id),i.onChange()}}]}}_uiContentDisplayedField(e="",t,i){const s=this,o=s.ids,l=this.CurrentView.datacollection.datasource,r=l.id,d=l.fieldByID($$(o.contentField).getValue()).datasourceLink,c=d.id,h=t?.id||c,u=$$(o.contentDisplayedFields),p=$$(o.contentDisplayedFieldTypes),g=$$(o.contentDisplayedFieldMappingData),m=$$(o.contentDisplayedFieldFilters),b=e=>{const t=e.datasourceLink?.id;return t!==r&&t!==c},f=(e,t)=>i=>{const a=e.fieldByID(i);"connectObject"===a.key&&u.addView(this._uiContentDisplayedField("",a.datasourceLink,t)),this.populateContentDisplayedFields(u.getValues(),p.getValues(),g.getValues(),m.getValues()),this.onChange()};if(h===c){const t=Object.keys(u.elements).filter((e=>e.includes(h))).length;return{cols:[{view:"richselect",name:`${t}.${c}`,label:`${n("Display")} ${t+1}`,labelWidth:a.labelWidthMedium,options:d.fields(b).map(y)||[],value:e,on:{onChange:f(d,t)}},{view:"button",css:"webix_danger",type:"icon",icon:"wxi-close",width:a.buttonWidthExtraSmall,click(){s.deleteContentDisplayedField(this.getParentView().getChildViews()[0].config.id),s.onChange()}}]}}return{cols:[{view:"richselect",name:`${i}.${h}`,label:"->",labelWidth:a.labelWidthMedium,options:t.fields(b).map(y)||[],value:e,on:{onChange:f(t,i)}},{view:"button",css:"webix_danger",type:"icon",icon:"wxi-close",width:a.buttonWidthExtraSmall,click(){s.deleteContentDisplayedField(this.getParentView().getChildViews()[0].config.id),s.onChange()}}]}}ui(){const e=this.ids,t=this.contentFieldFilter;return super.ui([{id:e.datacollectionID,name:"datacollectionID",view:"richselect",label:n("Team Data"),labelWidth:a.labelWidthLarge,options:[],on:{onChange:e=>{this.CurrentView.settings.datacollectionID=e;const t=this.CurrentView?.datacollection?.datasource;this.populateTeamFieldOptions(t),this.onChange()}}},{id:e.teamLink,view:"richselect",label:n("Team Link"),labelWidth:a.labelWidthLarge,options:[],on:{onChange:()=>this.onChange()}},{id:e.teamName,view:"richselect",label:n("Team Name"),labelWidth:a.labelWidthLarge,options:[],on:{onChange:()=>this.onChange()}},{id:e.topTeam,view:"richselect",label:n("Top Team"),labelWidth:a.labelWidthLarge,options:[],on:{onChange:()=>this.onChange()}},{id:e.teamInactive,view:"richselect",label:n("Team Inactive"),labelWidth:a.labelWidthLarge,options:[],on:{onChange:()=>this.onChange()}},{id:e.teamCanInactivate,view:"richselect",label:n("Can Inactivate"),labelWidth:a.labelWidthLarge,options:[],on:{onChange:()=>this.onChange()}},{cols:[{view:"label",label:n("Content Field"),width:a.labelWidthLarge},{id:e.contentField,name:"contentField",view:"richselect",options:[],on:{onChange:i=>{const a=$$(e.editContentFieldsToCreateNew),n=$$(e.setEditableContentFields),s=$$(e.contentDisplayedFieldsAdd),o=$$(e.contentFieldFilterButton),l=$$(e.contentGroupByField),r=$$(e.contentFieldDateStart),d=$$(e.contentFieldDateEnd),c=$$(e.showGroupTitle);if(t.init(),t.setValue({glue:"and",rules:[]}),null!=i&&""!==i){const e=this.CurrentView.datacollection.datasource.fieldByID(i).datasourceLink.fields(),h=e.filter((e=>"date"===e.key||"datetime"===e.key));r.define("options",h.map(y)),d.define("options",h.map(y));const u=e.map((e=>({id:e.id,value:e.label})));a.define("options",u),n.define("options",u),t.fieldsLoad(e),l.define("options",[{id:"",value:"",$empty:!0},...e.filter((e=>"connectObject"===e.key)).map(y)]),a.enable(),o.enable(),s.show(),r.show(),d.show(),l.show(),c.show()}else a.define("options",[]),t.fieldsLoad([]),l.define("options",[]),a.enable(),o.disable(),s.hide(),r.hide(),d.hide(),l.hide(),c.hide();a.setValue([]),c.setValue(0),l.setValue(""),this.populateContentDisplayedFields(),this.onChange()}}},{id:e.contentFieldFilterButton,view:"button",type:"icon",icon:"fa fa-filter",css:"webix_primary",disabled:!0,width:a.buttonWidthExtraSmall,click(){t.popUp(this.$view,null,{pos:"top"})}}]},{id:e.contentFieldDateStart,name:"contentFieldDateStart",label:n("Date Start"),labelWidth:a.labelWidthLarge,view:"richselect",options:[],on:{onChange:()=>{this.onChange()}}},{id:e.contentFieldDateEnd,name:"contentFieldDateEnd",label:n("Date End"),labelWidth:a.labelWidthLarge,view:"richselect",options:[],on:{onChange:()=>{this.onChange()}}},{id:e.contentGroupByField,hidden:!0,view:"richselect",label:n("Content Group By Field"),labelWidth:a.labelWidthLarge,options:[],on:{onChange:()=>{this.onChange()}}},{id:e.showGroupTitle,hidden:!0,name:"showGroupTitle",view:"checkbox",label:n("Show Group Title"),labelWidth:a.labelWidthLarge,value:0,on:{onChange:()=>{this.onChange()}}},{rows:[{view:"label",label:n("Force the creation of a new row of data by editing the content fields")},{id:e.editContentFieldsToCreateNew,view:"multicombo",value:[],options:[],placeholder:n("Choose the content fields to create a new entry through editing"),labelAlign:"left",stringResult:!1,on:{onChange:()=>{this.onChange()}}},{view:"label",label:n("Set the editable content fields")},{id:e.setEditableContentFields,view:"multicombo",value:[],options:[],placeholder:n("Choose the editable content fields"),labelAlign:"left",stringResult:!1,on:{onChange:()=>{this.onChange()}}}]},{id:e.contentDisplayedFieldsAdd,hidden:!0,cols:[{view:"label",label:n("Content Displayed Fields")},{view:"button",type:"icon",icon:"fa fa-plus",css:"webix_primary",width:a.buttonWidthExtraSmall,click:()=>{const t=$$(e.contentDisplayedFields);t.isVisible()||t.show(),t.addView(this._uiContentDisplayedField())}}]},{id:e.contentDisplayedFields,view:"form",hidden:!0,elements:[]},{id:e.contentDisplayedFieldTypesSet,hidden:!0,rows:[{view:"label",label:n("Set content active displays and displayed types")},{id:e.contentDisplayedFieldTypes,view:"form",elements:[]}]},{id:e.contentDisplayedFieldMappingDataSet,hidden:!0,rows:[{view:"label",label:n("Set content mapping displayed data")},{id:e.contentDisplayedFieldMappingData,view:"form",elements:[]}]},{id:e.contentDisplayedFieldFiltersSet,hidden:!0,rows:[{view:"label",label:n("Set content displayed filters by field")},{id:e.contentDisplayedFieldFilters,view:"form",elements:[]}]},{id:e.showDataPanel,name:"showDataPanel",view:"checkbox",label:n("Show Data Panel"),labelWidth:a.labelWidthLarge,value:0,on:{onChange:t=>{const i=$$(e.dataPanelDCsAdd);1===t?i.show():i.hide(),this.populateDataPanelDCs({}),this.onChange()}}},{id:e.dataPanelDCsAdd,hidden:!0,cols:[{view:"label",label:n("Data Panel DCs")},{view:"button",type:"icon",icon:"fa fa-plus",css:"webix_primary",width:a.buttonWidthExtraSmall,click:()=>{const t=$$(e.dataPanelDCs);t.isVisible()||t.show(),t.addView(this._uiDataPanelDC())}}]},{id:e.dataPanelDCs,view:"form",hidden:!0,elements:[]},{id:e.teamStrategy,view:"richselect",label:n("Strategy"),labelWidth:a.labelWidthLarge,options:[],on:{onChange:e=>{this.populateStrategyOptions(e),this.onChange()}}},{cols:[{id:e.strategyCode,view:"richselect",label:n("Strategy Code"),labelWidth:a.labelWidthLarge,options:[],on:{onChange:()=>{this.onChange(),$$(this.ids.strategyColorPopup)?.close()}}},{view:"icon",icon:"fa fa-paint-brush",allign:"right",click:()=>this.strategyColorPopup()}]},{id:e.subStrategy,view:"richselect",label:n("Sub Strategy"),labelWidth:a.labelWidthLarge,options:[],on:{onChange:()=>this.onChange()}},{id:e.draggable,name:"draggable",view:"checkbox",label:n("Drag & Drop"),labelWidth:a.labelWidthLarge,value:0,on:{onChange:t=>{const i=$$(e.dropContentToCreate);0===t?(i.setValue(0),i.hide()):i.show(),this.onChange()}}},{id:e.dropContentToCreate,name:"dropContentToCreate",view:"checkbox",label:n("Drop content to create"),labelWidth:a.labelWidthLarge,hidden:!0,value:0,on:{onChange:()=>this.onChange()}},{id:e.direction,name:"direction",view:"richselect",label:n("Direction"),labelWidth:a.labelWidthLarge,options:[{id:"t2b",value:n("Top to Bottom")},{id:"b2t",value:n("Bottom to Top")},{id:"l2r",value:n("Left to Right")},{id:"r2l",value:n("Right to Left")}],on:{onChange:()=>this.onChange()}},{id:e.entityDatacollection,name:"entityDatacollection",view:"richselect",label:n("Entity"),labelWidth:a.labelWidthLarge,options:[],on:{onChange:()=>this.onChange()}},{id:e.depth,name:"depth",hidden:!0,view:"counter",label:n("Depth"),labelWidth:a.labelWidthLarge,value:0,on:{onChange:()=>this.onChange()}},{hidden:!0,id:e.pan,name:"pan",view:"checkbox",label:n("Pan"),labelWidth:a.labelWidthLarge,value:0,on:{onChange:()=>this.onChange()}},{hidden:!0,id:e.zoom,name:"zoom",view:"checkbox",label:n("Zoom"),labelWidth:a.labelWidthLarge,value:0,on:{onChange:()=>this.onChange()}},{id:e.height,view:"counter",name:"height",label:n("Height"),labelWidth:a.labelWidthLarge,on:{onChange:()=>this.onChange()}},{hidden:!0,view:"fieldset",label:n("Export"),body:{view:"layout",borderless:!0,rows:[{id:e.export,name:"export",view:"checkbox",label:n("Is Exportable"),labelWidth:a.labelWidthLarge,value:0,on:{onChange:()=>{this.onChange()}}},{id:e.exportFilename,view:"text",name:"exportFilename",label:n("File name"),placeholder:n("Enter file name"),labelWidth:a.labelWidthLarge}]}}])}async init(e){this.AB=e,await super.init(e),webix.extend($$(this.ids.component),webix.ProgressBar),this.contentFieldFilter.queriesLoad(this.CurrentApplication?.queriesIncluded())}deleteContentDisplayedField(e){const t=this.ids,i=$$(t.contentDisplayedFields),a=i.elements,n=$$(e),s=n.config.name;if(s.includes(this.CurrentView.datacollection.datasource.fieldByID($$(t.contentField).getValue()).datasourceLink.id)){const e=s.split(".")[0];for(const t in a)t.includes(`${e}.`)&&i.removeView(a[t].getParentView().config.id)}else i.removeView(n.getParentView().config.id);this.populateContentDisplayedFields(i.getValues())}deleteDataPanelDC(e){const t=$$(this.ids.dataPanelDCs);t.removeView(e),this.populateDataPanelDCs(t.getValues())}populate(e){super.populate(e);const t=this.ids,i=$$(t.component),a=this.defaultValues(),n=Object.assign(i.getValues(),Object.assign(a,e.settings));this.populateDatacollection(n.datacollectionId);const s=this.CurrentView?.datacollection?.datasource;s&&(this.populateTeamFieldOptions(s),["teamCanInactivate","teamInactive","teamLink","teamName","teamStrategy","topTeam","contentField","contentGroupByField","editContentFieldsToCreateNew","setEditableContentFields","showGroupTitle","showDataPanel"].forEach((e=>$$(t[e]).setValue(n[e]))),this.contentFieldFilter.setValue(JSON.parse(n.contentFieldFilter)),this.populateContentDisplayedFields(n.contentDisplayedFields,n.contentDisplayedFieldTypes,n.contentDisplayedFieldMappingData,n.contentDisplayedFieldFilters),this.populateDataPanelDCs(n.dataPanelDCs),n.teamStrategy&&(this.populateStrategyOptions(n.teamStrategy),$$(t.strategyCode).setValue(n.strategyCode),$$(t.subStrategy).setValue(n.subStrategy))),i.setValues(n)}populateDatacollection(e){const t=$$(this.ids.datacollectionID),i=this.CurrentView.application.datacollectionsIncluded().map((e=>({id:e.id,value:e.label})));t.define("options",i),t.define("value",e),t.refresh(),$$(this.ids.entityDatacollection).define("options",i),$$(this.ids.entityDatacollection).refresh()}refreshValueFieldOptions(e=[]){const t=this.ids,i=this.CurrentView,a=$$(t.fields);a.clearAll(),this.populateSubValueFieldOptions(i.datacollection?.datasource),e.forEach((e=>{if(!e)return;const t=a.getItem(e);if(t){const i=t.field;this.populateSubValueFieldOptions(i.datasourceLink,e)}})),a.blockEvent(),e.forEach((e=>{a.exists(e)&&a.checkItem(e)})),a.unblockEvent()}populateTeamFieldOptions(e){const t=this.CurrentView,i=this.ids,a=t.getValueFields(e).map(y),n=e.connectFields((e=>"one"==e.linkType()&&"many"==e.linkViaType()))??[];$$(i.teamStrategy).define("options",n.map(y)),$$(i.teamLink).define("options",a);const s=e?.fields((e=>"string"===e.key)).map(y);$$(i.teamName).define("options",s);const o=e?.fields((e=>"boolean"===e.key)).map(y);o.unshift({id:"",value:"",$empty:!0}),$$(i.topTeam).define("options",o),$$(i.teamInactive).define("options",o),$$(i.teamCanInactivate).define("options",o),$$(i.contentField).define("options",[{id:"",value:"",$empty:!0},...a])}populateContentDisplayedFields(e={},t={},i={},s={}){const o=this,l=this.AB.Webix,r=this.ids,d=$$(r.contentDisplayedFields),c=d.elements;for(const e in c)d.removeView(c[e].getParentView().config.id);const h=$$(r.contentDisplayedFieldTypes),u=h.elements,p=$$(r.contentDisplayedFieldTypesSet);for(const e in u)h.removeView(u[e].getParentView().config.id);const g=$$(r.contentDisplayedFieldMappingData),m=g.elements,y=$$(r.contentDisplayedFieldMappingDataSet),b=$$(r.contentDisplayedFieldFilters);for(const e in m)g.removeView(m[e].getParentView().config.id);const f=b.elements,w=$$(r.contentDisplayedFieldFiltersSet);for(const e in f)b.removeView(f[e].getParentView().config.id);p.hide(),y.hide(),w.hide();const D=Object.keys(e);if(0===D.length)return void d.hide();const C=this.CurrentView.datacollection.datasource.fieldByID($$(r.contentField).getValue())?.datasourceLink;if(null==C)return d.hide(),void $$(r.contentDisplayedFieldsAdd).hide();const v=Object.keys(t),_=Object.keys(s),F=C.id,$=[],S=[],k=(e,r)=>{const c=`${e}.${r.id}`,u=r.label,p=v.findIndex((e=>e.indexOf(c)>-1)),m=parseInt(v.find((e=>e.indexOf(c)>-1))?.split(".")[3]);h.addView({cols:[{view:"switch",label:u,labelWidth:a.labelWidthMedium,value:isNaN(m)?1:m,on:{onChange:(e,t)=>{const i=h.getValues(),a=Object.entries(i),n={},s=`${c}.${t}`;for(const[t,i]of a)t.indexOf(s)>-1?n[`${c}.${e}`]=i:n[t]=i;this.populateContentDisplayedFields(d.getValues(),n,g.getValues(),b.getValues()),this.onChange()},onViewShow(){this.getParentView().addView({view:"richselect",options:[{id:"icon",value:"Icon"},{id:"image",value:"Image"},{id:"svg",value:"SVG"},{id:"text",value:"Text"}],name:`${c}.${this.getValue()}`,value:p>-1&&t[v[p]]||"text",on:{onChange:()=>{o.onChange()}}})}}}]});const y=i[c];g.addView({cols:[{view:"label",label:u,width:a.labelWidthMedium},{view:"button",label:"Set",width:a.buttonWidthExtraSmall,click:()=>{const e=(e="",t="")=>({cols:[{view:"text",placeholder:n("The value need to map."),value:e},{view:"label",label:n("to"),align:"center",width:a.labelWidthSmall},{view:"text",placeholder:(()=>{switch(t){case"icon":return n("Icon class text.");case"image":case"svg":return n("Image url or Base64 (ex. data:image/png;base64,AAABBBCCC) url.");default:return n("New text.")}})(),value:t},{view:"button",css:"webix_danger",type:"icon",icon:"wxi-close",width:a.buttonWidthExtraSmall,click(){const e=this.getParentView();e.getParentView().removeView(e.config.id)}}]}),t=l.ui({view:"window",close:!0,title:n("Map Data"),position:"center",body:{view:"form",elements:[{view:"button",label:n("Add a value"),click(){this.getParentView().getChildViews()[1].addView(e())}},{rows:[]},{view:"button",label:n("Apply"),click(){const e={},i=this.getParentView().getChildViews()[1].getChildViews();for(const t of i){const i=t.getChildViews();e[i[0].getValue()]=i[2].getValue()}g.elements[c]?.setValue(JSON.stringify(e)),t.hide(),o.onChange()}}]},on:{onHide(){this.destructor()}}});try{const i=t.getChildViews()[1].getChildViews()[1],a=JSON.parse(y);for(const t in a)i.addView(e(t,a[t]))}catch{}t.show()}},{view:"text",name:c,disabled:!0,value:y||JSON.stringify({})}]});const f=parseInt(_.find((e=>e.indexOf(c)>-1))?.split(".")[3]);b.addView({cols:[{view:"checkbox",label:u,labelWidth:a.labelWidthMedium,value:isNaN(f)?0:f,on:{onChange:(e,t)=>{const i=b.getValues(),a=Object.entries(i),n={},s=`${c}.${t}`;for(const[t,i]of a)t===s?n[`${c}.${e}`]="":n[t]=i;this.populateContentDisplayedFields(d.getValues(),h.getValues(),g.getValues(),n),this.onChange()},onViewShow(){const e=this.getValue(),t=`${c}.${e}`;this.getParentView().addView({view:"text",placeholder:n("Add the new field label."),name:t,value:s[t]||u,disabled:1!==e,on:{onChange:()=>{o.onChange()}}})}}}]})};for(;D.length>0;){const e=D.pop();e.includes(F)&&$.push(e)||S.push(e)}for(;$.length>0;){const t=$.pop(),i=e[t]??"";d.addView(this._uiContentDisplayedField(i));const a=C.fieldByID(i);if(null==a)continue;switch(a.key){case"connectObject":case"user":break;default:k(t,a);continue}const n=Object.keys(d.getValues()).filter((e=>e.includes(F))).length-1;for(;S.findIndex((e=>e.includes(`${t.split(".")[0]}.`)))>-1;){const t=S.pop(),i=this.AB.objectByID(t.split(".")[1]),a=e[t]??"";d.addView(this._uiContentDisplayedField(a,i,n));const s=i.fieldByID(a);if(null!=s)switch(s.key){case"connectObject":case"user":break;default:k(t,s);continue}}}d.show(),p.show(),y.show(),w.show()}populateDataPanelDCs(e){const t=this.ids,i=$$(t.dataPanelDCs),a=i.getChildViews();for(;a.length>0;)i.removeView(a[0].config.id);i.hide();const n=$$(t.contentField).getValue(),s=Object.keys(e);if(null!=n&&""!==n&&0!==s.length){for(;s.length>0;){const t=s.shift();i.addView(this._uiDataPanelDC(e[t]??"",t.split(".")[1]??""))}i.show()}}populateStrategyOptions(e){const t=this.AB.objectByID(this.AB.definitionByID(e).settings.linkObject).fields((e=>"connectObject"===e.key)).map(y);$$(this.ids.strategyCode).define("options",t),$$(this.ids.subStrategy).define("options",t)}async strategyColorPopup(){const e=$$(this.ids.strategyCode).getValue();if(!e)return;let t=$$(this.ids.strategyColorPopup);if(!t){const i=this.CurrentView.settings.strategyColors??{},a=this.AB.definitionByID(e).settings.linkObject,s=(await this.AB.objectByID(a).model().findAll()).data.map((e=>({view:"colorpicker",label:e.name,name:e.id,value:i[e.id]??"#111111",suggest:{type:"colorselect",body:{button:!0}}})));t=this.AB.Webix.ui({view:"window",id:this.ids.strategyColorPopup,close:!0,title:n("Set Colors"),position:"center",body:{view:"form",id:this.ids.strategyColorForm,elements:[...s,{view:"button",label:n("Apply"),click:()=>{this.onChange(),$$(this.ids.strategyColorPopup).hide()}}]}})}t.show()}defaultValues(){const e=this.ViewClass();let t=null;return e&&(t=e.defaultValues()),t}values(){const e=super.values(),t=this.ids,i=e.settings=Object.assign($$(t.component).getValues(),e.settings);i.teamLink=$$(t.teamLink).getValue(),i.teamName=$$(t.teamName).getValue(),i.topTeam=$$(t.topTeam).getValue(),i.teamInactive=$$(t.teamInactive).getValue(),i.teamCanInactivate=$$(t.teamCanInactivate).getValue(),i.teamStrategy=$$(t.teamStrategy).getValue(),i.subStrategy=$$(t.subStrategy).getValue(),i.strategyCode=$$(t.strategyCode).getValue(),i.dataCollectionId=$$(t.datacollectionID).getValue(),i.contentField=$$(t.contentField).getValue(),i.contentGroupByField=$$(t.contentGroupByField).getValue(),i.editContentFieldsToCreateNew=$$(t.editContentFieldsToCreateNew).getValue(),i.setEditableContentFields=$$(t.setEditableContentFields).getValue(),i.contentFieldFilter=JSON.stringify(this.contentFieldFilter.getValue()),i.contentDisplayedFields=$$(t.contentDisplayedFields).getValues(),i.contentDisplayedFieldTypes=$$(t.contentDisplayedFieldTypes).getValues(),i.contentDisplayedFieldMappingData=$$(t.contentDisplayedFieldMappingData).getValues(),i.contentDisplayedFieldFilters=$$(t.contentDisplayedFieldFilters).getValues(),i.contentFieldDateStart=$$(t.contentFieldDateStart).getValue(),i.contentFieldDateEnd=$$(t.contentFieldDateEnd).getValue(),i.dataPanelDCs=$$(t.dataPanelDCs).getValues();const a=$$(t.strategyColorForm);return i.strategyColors=a?.getValues()??i.strategyColors,e}ViewClass(){return super._ViewClass("plugin_hr_teams")}}}function y(e){return{id:e.id,value:e.label,field:e}}const b={version:"1.0.0",key:"HRTeams",apply:function(e){const t=u(e.Class.ABViewManager.viewClass("view"),e.Class.ABViewComponent);e.Class.ABViewManager.addViewClass(t),e.applications().forEach((e=>{e.views((e=>"plugin_hr_teams"===e.key)).forEach(((e,i,a)=>{const n=new t(e.toObj(),e.application,e.parent);a[i]=n;const s=e.parent;s.viewRemove(e),s.viewInsert(n)}))})),e.pluginLoad({id:this.key,isPlugin:!0,label:"HR Teams Widget",editor:g,viewProperty:m})},definitions:()=>[],labels:()=>[]};window.__AB_Plugins=window.__AB_Plugins||[],window.__AB_Plugins.push(b),o=s.O(o)})();